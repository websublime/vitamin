{"version":3,"file":"PluginLoader.js","sourceRoot":"","sources":["../../src/plugin/PluginLoader.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\n// See LICENSE in the project root for license information.\n\nimport * as path from 'path';\nimport * as resolve from 'resolve';\n\nimport { IApiDocumenterPluginManifest, IFeatureDefinition } from './IApiDocumenterPluginManifest';\nimport { MarkdownDocumenterFeature, MarkdownDocumenterFeatureContext } from './MarkdownDocumenterFeature';\nimport { PluginFeatureInitialization } from './PluginFeature';\nimport { DocumenterConfig } from '../documenters/DocumenterConfig';\n\ninterface ILoadedPlugin {\n  packageName: string;\n  manifest: IApiDocumenterPluginManifest;\n}\n\nexport class PluginLoader {\n  public markdownDocumenterFeature: MarkdownDocumenterFeature | undefined;\n\n  public load(\n    documenterConfig: DocumenterConfig,\n    createContext: () => MarkdownDocumenterFeatureContext\n  ): void {\n    const configFileFolder: string = path.dirname(documenterConfig.configFilePath);\n    for (const configPlugin of documenterConfig.configFile.plugins || []) {\n      try {\n        // Look for the package name in the same place as the config file\n        const resolvedEntryPointPath: string = resolve.sync(configPlugin.packageName, {\n          basedir: configFileFolder\n        });\n\n        // Load the package\n        const entryPoint:\n          | { apiDocumenterPluginManifest?: IApiDocumenterPluginManifest }\n          | undefined = require(resolvedEntryPointPath);\n\n        if (!entryPoint) {\n          throw new Error('Invalid entry point');\n        }\n\n        if (!entryPoint.apiDocumenterPluginManifest) {\n          throw new Error(\n            `The package is not an API documenter plugin;` +\n              ` the \"apiDocumenterPluginManifest\" export was not found`\n          );\n        }\n\n        const manifest: IApiDocumenterPluginManifest = entryPoint.apiDocumenterPluginManifest;\n\n        if (manifest.manifestVersion !== 1000) {\n          throw new Error(\n            `The plugin is not compatible with this version of API Documenter;` +\n              ` unsupported manifestVersion`\n          );\n        }\n\n        const loadedPlugin: ILoadedPlugin = {\n          packageName: configPlugin.packageName,\n          manifest\n        };\n\n        const featureDefinitionsByName: Map<string, IFeatureDefinition> = new Map<\n          string,\n          IFeatureDefinition\n        >();\n        for (const featureDefinition of manifest.features) {\n          featureDefinitionsByName.set(featureDefinition.featureName, featureDefinition);\n        }\n\n        for (const featureName of configPlugin.enabledFeatureNames) {\n          const featureDefinition: IFeatureDefinition | undefined = featureDefinitionsByName.get(featureName);\n          if (!featureDefinition) {\n            throw new Error(\n              `The plugin ${loadedPlugin.packageName} does not have a feature with name \"${featureName}\"`\n            );\n          }\n\n          if (featureDefinition.kind === 'MarkdownDocumenterFeature') {\n            if (this.markdownDocumenterFeature) {\n              throw new Error('A MarkdownDocumenterFeature is already loaded');\n            }\n\n            const initialization: PluginFeatureInitialization = new PluginFeatureInitialization();\n            initialization._context = createContext();\n\n            let markdownDocumenterFeature: MarkdownDocumenterFeature | undefined = undefined;\n            try {\n              markdownDocumenterFeature = new featureDefinition.subclass(initialization);\n            } catch (e) {\n              throw new Error(`Failed to construct feature subclass:\\n` + (e as Error).toString());\n            }\n            if (!(markdownDocumenterFeature instanceof MarkdownDocumenterFeature)) {\n              throw new Error('The constructed subclass was not an instance of MarkdownDocumenterFeature');\n            }\n\n            try {\n              markdownDocumenterFeature.onInitialized();\n            } catch (e) {\n              throw new Error('Error occurred during the onInitialized() event: ' + (e as Error).toString());\n            }\n\n            this.markdownDocumenterFeature = markdownDocumenterFeature;\n          } else {\n            throw new Error(`Unknown feature definition kind: \"${featureDefinition.kind}\"`);\n          }\n        }\n      } catch (e) {\n        throw new Error(`Error loading plugin ${configPlugin.packageName}: ` + (e as Error).message);\n      }\n    }\n  }\n}\n"]}